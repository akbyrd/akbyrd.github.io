{{ $resource := false }}

{{ $remote := findRE `^https?://` .Destination }}
{{ if $remote }}
	{{ $resource = resources.GetRemote .Destination }}

	{{ $resize := index .Attributes "resize" }}
	{{ if $resize }}
	 	{{/* TODO: Don't resize image. Parse resize args and do the math. */}}
		{{ $resource = $resource.Resize (printf "%s photo" $resize) }}
	{{ end }}
{{ else }}
	{{ $resource = partial "resource" (dict
		"Name" .Destination
		"Page" .Page
		"Resize" (index .Attributes "resize")
	) }}
{{ end }}

{{ if not $resource }}
	{{ errorf "Failed to find image \"%s\"\n\t%s" .Destination .Page.Path }}
{{ end }}

{{- /* */ -}}
<div class="container image{{ with (index .Attributes "class") }} {{ . }}{{ end }}">
	{{ if $remote }}
	<img src="{{ .Destination | safeURL }}"
	{{ else }}
	<img src="{{ $resource.RelPermalink | safeURL }}"
	{{ end  }}
		{{ with .Text }}alt="{{ . }}"{{ end }}
		{{ with .Title }}title="{{ . }}"{{ end }}
		{{ with $resource.Width }}width="{{ . }}"{{ end }}
		{{ with $resource.Height }}height="{{ . }}"{{ end }}
		decoding="async" loading="lazy" />
</div>
{{- /* */ -}}
