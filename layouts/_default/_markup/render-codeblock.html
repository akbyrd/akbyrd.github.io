{{- $class := "highlight" }}
{{- with index .Attributes "class" }}
	{{- $class = printf "%s %s" $class . }}
{{- end }}

{{- $opts := dict "lineNumbersInTable" true }}
{{- $result := (transform.HighlightCodeBlock . $opts).Wrapped -}}

{{- $button := "<button class=\"code-copy require-js\" type=\"button\" aria-label=\"Copy\"><p>&#xf4bb;</p></button>" }}
{{- $buttonFmt := printf "%s\n$1" $button }}

{{- $result = replaceRE `^<div class="highlight[^"]*">` "" $result }}
{{- $result = replaceRE "(</div>)\n</div>" $buttonFmt $result }}
{{- $result = replaceRE `(<table( class="[^"]*">)?)\n?` "$1\n" $result }}
{{- $result = replaceRE `\n?(</table>)\n?` "\n$1\n" $result }}
{{- $result = replaceRE `\n?(</?tr>)\n?` "\n$1\n" $result }}
{{- $result = replaceRE `\n?(</?td>)\n?` "\n$1\n" $result }}
{{- $result = replace $result " tabindex=\"0\"" "" }}
{{- $result = replace $result "pre class=\"chroma\"" "pre" }}
{{- $result | safeHTML -}}
